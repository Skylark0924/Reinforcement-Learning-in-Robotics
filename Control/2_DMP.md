# DYNAMIC MOVEMENT PRIMITIVES PART 1: THE BASICS

[[TOC]]

动态运动基元 （DMPs） 是 Stefan Schaal 实验室的轨迹控制/规划方法。早在2002年，他们出现在[这篇文章](http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.142.3886)中，然后在2013年由 Auke Ijspeert 在[另一篇文章](http://www-clmc.usc.edu/publications/I/ijspeert-NC2013.pdf)中更新。这项工作的动机是**希望找到一种方法来表征复杂的运动动作，可以灵活调整，无需手动参数调整且不必担心不稳定。**

长期以来，人们一直认为复杂的运动是由一组基元动作"building blocks"按顺序和/或并行执行的，而DMP为这些基元而提出的数学化公式。DMP 和先前提出的 building blocks 的区别在于，每个 DMP 都是**非线性动态系统**。基本的思想是，针对一个明确、稳定的行为的动态系统，添加另一项使其遵循一些有趣的轨迹。

DMP 有两种类型：discrete and rhythmic（离散和节律型）。！！！对于离散运动，基础系统是点吸引器，对于节律运动，使用限制周期。！！！本文关注离散DMP，因为我们需要很长时间掌握所有的基础知识。

想象一下，你有两个系统：一个假想的系统（在那里你规划轨迹），一个真正的系统（执行运动）。当使用 DMP 时，正在执行的工作是规划真实系统遵循的轨迹。DMP 有自己的一组dynamics，通过正确设置 DMP，可以获得使实际系统跟随目标轨迹的控制信号。如果我们的 DMP 系统正在规划一条手跟随的路径，那么发送到真实系统的是需要应用到手上的一组力。它是由真正的系统采取这些手力，并应用他们，通过转换到关节扭矩或肌肉激活（通过类似操作空间控制框架的东西）或什么的。这就是我在这里要说的关于真正的系统， 我们将在这里关注的是 Dmp 系统。但请记住，整个 DMP 框架用于生成轨迹 - 控制信号来指导真实系统。

## Discrete DMPs
让我们从点吸引力动力学：
> 所谓吸引子指的是一个动力学系统在不接受外界输入情况下靠自身动力学就能维持的非静息的稳定状态（active stationary state）

$$
\ddot{y}=\alpha_{y}\left(\beta_{y}(g-y)-\dot{y}\right)
$$

y 是系统状态， g 是目标， $\alpha, \beta$ 是增益项。这就是一个PD控制信号，要做的就是使系统达到目标。现在，我们要做的是增加一个力项，这将使我们修改这个轨迹：

$$
\ddot{y}=\alpha_{y}\left(\beta_{y}(g-y)-\dot{y}\right) + f
$$

如何定义一个非线性函数 $f$ 是一个non-trivial问题。DMP 框架是一个额外的非线性系统，用于定义随时间推移的力函数 f，为问题提供了一个清晰的解决思路，并且很容易泛化。引入的系统称为规范动态系统（canonical dynamical system），以 x 来表示，并且具有非常简单的动力学：

$$
\dot{x}=-\alpha_{x} x
$$

力函数 f 被定义为规范系统的函数：

$$
f(x, g)=\frac{\sum_{i=1}^{N} \psi_{i} w_{i}}{\sum_{i=1}^{N} \psi_{i}} x\left(g-y_{0}\right)
$$

其中$y_0$是系统的初始位置，$\psi_{i}=\exp \left(-h_{i}\left(x-c_{i}\right)^{2}\right)$ 为基函数，$\omega_i$ 是基函数 $\psi_i$ 的权重。很明显，基函数是一个均值在 $c_i$，方差为 $h_i$ 的高斯分布。所以力函数就是一组高斯，当规范系统 x 收敛到目标时，这些高斯分布被"激活"。它们的加权和是归一化的，然后乘以 $x(g-y_0)$项，这既是"递减"，也是空间缩放项。

让我们把这个分解一下。规范系统从某些任意值开始，本文中$x_0 = 1$，随着时间的流逝，到 0。现在，让我们假装 x 线性衰变为 0。
1. 有一些基函数被激活为 x 的函数，这显示在下面的顶部图中。当 x 值从 1 减少到 0 时，每个高斯分布都会围绕不同的 x 值激活（也就是以其为中心）。第二件事是，这些基础函数中的每一个也被分配了权重，$w_i$。这些权重显示在下图的第二子图中。力函数 f 的输出是这些基函数的激活乘以权重量的总和，也显示在下图中。

![](https://pic4.zhimg.com/80/v2-8d409f3d3ae4f61d5b5d9575c2db09a2.png)

### The diminishing term
将 x 项纳入里函数可保证力随着时间推移变为零，就像规范系统所做的那样。这意味系统可以追踪到一些疯狂的路径，不管怎样最终都会回到其更简单的点吸引动态且收敛到目标。

### Spatial scaling
空间缩放意味着，一旦我们建立了系统，按照预期的轨迹到特定目标，我们希望能够将目标移得更远或更近，并得到我们轨迹的缩放版本。这就是力函数的 $(g - y_0)$ 项的含义。通过将这些基函数的激活缩放为相对于目标的距离，导致系统覆盖更多或更少的距离。例如，假设我们设置了一组离散的 DMP，以遵循给定的轨迹：

![](https://pic4.zhimg.com/80/v2-fb154d8254815dc1d13e5a555a5af4f3.png)

上图中，目标是 1 和 0.5。假设我们现在想繁华到此轨迹的放大版本，以便 DMP 移动到 2 的目标。如果我们没有适当地扩展我们的力函数，即 $(g - y_0)$ 项， 那么我们最终会得到这样：

![](https://pic4.zhimg.com/80/v2-643e1dbbda167b6555a9d560353b8988.png)

对于这些新目标，基函数的相同权重不足以使其遵循期望轨迹。但是，一旦将  $(g - y_0)$ 项包含在力函数中，我们就会得到：

![](https://pic4.zhimg.com/80/v2-cdc5b730aea7812d49698cbb329bb2e1.png)

### Spreading basis function centers

现在，不幸的是，规范系统并没有像上面假设的那样线性地与目标融合。以下是线性衰变与实际系统指数衰变的比较：

![](https://pic4.zhimg.com/80/v2-3496efc3d02fcfec351e4868ea485bad.png)

这是一个问题，因为我们的基函数的激活取决于 x。如果系统是线性的，那么基函数的激活将随着系统收敛到目标很好地分散。但是，从实际动态系统中来看，x 不是时间的线性函数。当我们将基函数的激活作为时间函数进行绘图时，我们看到，当 x 在开始快速移动时，大多数激活立即被激活，然后当 x 在结束时减慢时激活会伸展出来：

![](https://pic4.zhimg.com/80/v2-3b29d94fe5610a3071539a1f4505d839.png)

为了让基函数随着时间而更加均匀地间隔（这样，我们的力函数仍然可以在系统接近目标时沿着有趣的路径移动系统），我们需要更精明地选择我们的高斯中心点。如果我们随着时间推移查看 x 值，可以选择希望高斯分布被激活的时间，然后反向找到相应的 x 值。

![](https://pic4.zhimg.com/80/v2-952bd1304353fa88b0a448fcb95313f6.png)

红点是我们希望高斯分布均值所在的时刻， 蓝线是我们的规范系统 x 。通过点划线，可以找到高斯分布需要围绕的x值。此外，我们需要担心一点高斯的宽度，因为那些激活以后将被激活更长的时间。要将其均匀地伸出，以后的基础函数宽度应该更小。通过非常非分析性的试验和错误方法，我来计算方差

$$
h_{i}=\frac{\# B F s}{c_{i}}
$$

其中读取基函数 i 的方差等于按该基函数的中心划分的基函数数。当我们这样做时，我们现在可以生成我们的基函数中心，这些中心间隔良好：

![](https://pic4.zhimg.com/80/v2-e68b4a323ca88461a22524bb126d767a.png)

### Temporal scaling
同样，泛化性是我们想要从这个系统中得到的真正重要的东西之一。有两种明显的类型，时间和空间。我们上面讨论的空间缩放，在时间上，我们希望能够以不同的速度遵循相同的轨迹。有时快速，有时缓慢，但总是跟踪相同的路径。为此，我们将在我们的系统动态中再增加一项，即 $\tau$，即我们的时间缩放项。鉴于我们的系统动力学是：

$$
\begin{gathered}
\ddot{y}=\alpha_{y}\left(\beta_{y}(g-y)-\dot{y}\right)+f, \\
\dot{x}=-\alpha_{x} x
\end{gathered}
$$

为了增加时间灵活性， 我们可以添加 $\tau$：

$$
\begin{aligned}
&\dot{y}+=\tau \ddot{y}, \\
&y+=\tau \dot{y}, \\
&x+=\tau \dot{x},
\end{aligned}
$$

要减慢速度就让 $\tau$ 在 0 和 1 之间，要加快速度则 $\tau > 1$。


## 模仿所需的路径
我们有一个力项，可以使系统在收敛到目标点的过程中采取奇怪的路径，并具有时间和空间的可扩展性。那么该如何设置系统以遵循指定的路径？

我们可以控制力项，影响着系统的加速度。因此，我们首先需要将期望的轨迹 $\mathbf{y}_d$ 二次求导，以获得加速度：

$$
\ddot{\mathbf{y}}_{d}=\frac{\partial}{\partial t} \dot{\mathbf{y}}_{d}=\frac{\partial}{\partial t} \frac{\partial}{\partial t} \mathbf{y}_{d}
$$

一旦有了理想的加速度轨迹，就需要消除基础的点吸引子系统的影响。我们有上面的方程，确切地说，点吸引子系统在每个时间点诱导的加速度是：

$$
\ddot{y}=\alpha_{y}\left(\beta_{y}(g-y)-\dot{y}\right)
$$

然后计算需要怎样的力项才能生成这个轨迹

$$
\mathbf{f}_{d}=\ddot{\mathbf{y}}_{d}-\alpha_{y}\left(\beta_{y}(g-\mathbf{y})-\dot{\mathbf{y}}\right)
$$

从这里我们知道，力项由通过时间激活的基函数的加权和组成，因此我们可以使用优化技术（如局部加权回归）来选择权重而不是基函数，以便力函数与所需的轨迹$\mathbf{f}_{d}$匹配。在局部加权回归，以最小化下式为优化目标：

$$
\Sigma_{t} \psi_{i}(t)\left(f_{d}(t)-w_{i}\left(x(t)\left(g-y_{0}\right)\right)\right)^{2}
$$

解为：

$$
w_{i}=\frac{\mathbf{s}^{T} \boldsymbol{\psi}_{i} \mathbf{f}_{d}}{\mathbf{s}^{T} \boldsymbol{\psi}_{i} \mathbf{s}}
$$

其中

$$
\mathbf{s}=\left(\begin{array}{c}
x_{t_{0}}\left(g-y_{0}\right) \\
\vdots \\
x_{t_{N}}\left(g-y_{0}\right)
\end{array}\right), \quad \psi_{i}=\left(\begin{array}{ccc}
\psi_{i}\left(t_{0}\right) & \ldots & 0 \\
0 & \ddots & 0 \\
0 & \ldots & \psi_{i}\left(t_{n}\right)
\end{array}\right)
$$

**至此，我们掌握了基础离散DMP的一切了。**

### Different numbers of basis functions

在模仿路径时，你会注意到随着轨迹的复杂性增加，所需的基函数数量也会增加。例如下图，系统试图遵循正弦波和高度非线性零碎函数：

![](https://pic4.zhimg.com/80/v2-fbfea7eb128299383f139411b699d182.png)

我们可以在第二种情况下看到，虽然 DMP 始终无法完全重现所需的轨迹，但随着基础函数的增加，近似性继续改善。从基础函数的放置方式来看，某些非线性领域会有这种缓慢的改进。使用了随着时间的推移，基础函数的中心均匀地分布，但对于仿制品，Schaal博士的实验室中还有另一种方法可以更战略性地放置基础函数。需求由该区域的函数复杂性决定，并相应地定义基础函数中心和宽度。在高度非线性领域，我们预计有许多狭窄的基础函数，在线性区域，我们期望的基础函数更少，但基础函数更宽。

## 结论

在这个框架中确实有很多权威，在这个基本设置上有很多扩展，包括整合系统反馈、DMP 的时空耦合、使用 DMP 获得控制以及轨迹控制、整合成本函数和强化学习、识别动作类型和其他真正令人兴奋的内容。 我偏离了几个地方的论文中使用的术语。
1. 我看不出有理由将二阶系统减少到两个一阶系统。在处理它时，我发现它更令人困惑，而不是有帮助，所以我让动力学仍是二阶系统。
2. 我也把 $\tau$ 项移到了右边，这样它就与代码相符了，这其实并不重要。
3. 我上面有点回避的东西是沿着多个维度进行规划的。其实很简单：DMP 框架只需按受控制的自由度分配一个 DMP。但是，在某些时候，这绝对值得明确说明。 
   
以顶层的 DMP 框架为基础，规划划强大、可泛化的运动，然后用底层的 OSC 执行这些命令，我们可以开始获得一些非常整洁的应用程序。